<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Analisis Titik Rawan Kecelakaan (Blackspot) Kabupaten Sukabumi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="assets/styles.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 70vh; }
    .popup-content { font-family: Arial, sans-serif; line-height: 1.4; }
    .popup-content h4 { margin: 0 0 5px; color: #b30000; }
    .popup-content p { margin: 2px 0; }
    .leaflet-tooltip {
      background: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 13px;
      padding: 3px 6px;
      border-radius: 4px;
    }
    body { font-family: Arial, sans-serif; color: #1f2937; }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }
    .intro-title { margin: 0 0 8px; font-size: 28px; color: #111827; }
    .intro-subtitle { margin: 0 0 16px; font-size: 16px; color: #4b5563; }
    .intro { margin-bottom: 16px; }
    /* Minimal inline fallback to ensure sidebar shows even if external CSS fails */
    .split {
      display: grid;
      grid-template-columns: 340px minmax(0, 1fr) 340px;
      gap: 16px;
      align-items: stretch;
      padding: 0 16px 24px;
    }
    .sidebar { background: #ffffff; border-radius: 12px; box-shadow: 0 6px 18px rgba(2,6,23,0.15); display: flex; flex-direction: column; }
    .analysis-panel { padding: 20px; }
    .analysis-panel .analysis-results { flex-grow: 1; }
    .analysis-panel .sidebar-hero svg { width: 32px; height: 32px; }
    .analysis-subtitle { color: #4b5563; margin: 4px 0 16px; font-size: 14px; }
    .analysis-controls { display: flex; flex-direction: column; gap: 16px; margin-bottom: 8px; }
    .analysis-controls .small { font-size: 13px; padding: 8px 12px; }
    .analysis-controls .control-row { display: flex; flex-wrap: wrap; gap: 12px; }
    .analysis-controls .control-row button { flex: 1; min-width: 150px; }
    .analysis-controls .full-width { width: 100%; }
    .radius-control { flex: 1; display: flex; flex-direction: column; }
    .radius-control label { font-size: 12px; font-weight: 600; color: #6b7280; letter-spacing: 0.02em; }
    .radius-input { display: flex; gap: 8px; margin-top: 6px; }
    .radius-input input {
      flex: 1;
      padding: 8px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
    }
    .analysis-results {
      margin-top: 18px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px dashed #d1d5db;
      min-height: 60px;
      font-size: 14px;
    }
    .analysis-results ul { margin: 8px 0 0 20px; padding: 0; }
    .analysis-results li { margin-bottom: 4px; }
    .radius-popup .leaflet-popup-content-wrapper {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #34d399;
      border-radius: 10px;
    }
    .radius-popup .leaflet-popup-tip {
      background: #ecfdf5;
      border: 1px solid #34d399;
    }
    @media (max-width: 1100px) {
      .split {
        grid-template-columns: 1fr;
      }
      #map {
        order: 3;
        height: 60vh;
      }
    }
  </style>
</head>
<body>
  <div class="container intro">
    <h1 class="intro-title">Analisis Titik Rawan Kecelakaan (Blackspot)</h1>
    <p class="intro-subtitle">Kabupaten Sukabumi</p>
    <p>
      Halaman ini menampilkan peta interaktif lokasi-lokasi rawan kecelakaan
      beserta informasi singkatnya. Silakan gulir ke bawah untuk melihat peta,
      pilih layer yang diinginkan, dan klik marker untuk detail lokasi.
    </p>
    <div style="margin-top: 12px;">
      <button id="refreshTrafficBtn" class="secondary-btn small" style="padding: 8px 16px; font-size: 14px;">
        ðŸ”„ Refresh Insiden Lalu Lintas
      </button>
      <span id="trafficStatus" style="margin-left: 12px; font-size: 13px; color: #6b7280;"></span>
    </div>
  </div>

  <div class="split">
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-hero">
        <div class="hero-top">
          <div class="hero-icon">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z"/></svg>
          </div>
          <div>
            <p class="hero-title">Blackspot Details</p>
            <p class="hero-subtitle">Klik marker pada peta untuk melihat ringkasan lokasi.</p>
          </div>
        </div>
        <div class="hero-divider"></div>
      </div>
      <div id="sidebar-content" class="sidebar-content">
        <div class="placeholder">
          <div class="dot"></div>
          <p>Pilih marker pada peta untuk menampilkan ringkasan kecelakaan.</p>
        </div>
      </div>
      <div class="sidebar-footer">
        <button id="reportBtn" class="primary-btn" disabled>Laporkan Lokasi</button>
        <button id="deleteBtn" class="danger-btn" disabled>Hapus Laporan</button>
      </div>
    </aside>
    <div id="map"></div>
    <aside id="analysis-sidebar" class="sidebar analysis-panel">
      <div class="sidebar-hero">
        <div class="hero-top">
          <div class="hero-icon">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 11l7 7 11-11" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
          <div>
            <p class="hero-title">Analisis Spasial</p>
            <p class="hero-subtitle">Tetapkan penanda referensi untuk menjalankan analisis jarak dan radius.</p>
          </div>
        </div>
        <div class="hero-divider"></div>
      </div>
      <p class="analysis-subtitle">
        Gunakan kontrol di bawah untuk mencari titik terdekat, mengambil semua titik dalam radius, menghitung jarak tempuh, serta jarak ke titik kecelakaan.
      </p>
      <div class="analysis-controls">
        <div class="control-row">
          <button id="setReferenceBtn" class="primary-btn small">Pilih Titik Referensi</button>
          <button id="setDestinationBtn" class="secondary-btn small">Pilih Titik Tujuan</button>
        </div>
        <div class="control-row">
          <button id="nearestBtn" class="secondary-btn small" disabled>Cari Titik Terdekat</button>
          <button id="distanceBtn" class="secondary-btn small" disabled>Hitung Jarak Tempuh</button>
        </div>
        <div class="control-row">
          <div class="radius-control">
            <label for="radiusInput">Radius (km)</label>
            <div class="radius-input">
              <input type="number" id="radiusInput" min="0.1" step="0.1" value="2" />
              <button id="radiusBtn" class="secondary-btn small" disabled>Titik Dalam Radius</button>
            </div>
          </div>
        </div>
        <button id="clearAnalysisBtn" class="danger-btn small full-width" disabled>Reset Analisis</button>
      </div>
      <div id="analysis-results" class="analysis-results">
        <p>Set penanda referensi untuk memulai analisis spasial.</p>
      </div>
    </aside>
  </div>

  <!-- Leaflet & Turf JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
    // ===============================
    // INISIALISASI MAP & BASE LAYER
    // ===============================
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap contributors'
    });

    var satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      maxZoom: 20,
      subdomains:['mt0','mt1','mt2','mt3'],
      attribution: 'Â© Google Satellite'
    });

    var map = L.map('map', {
      center: [-6.9241, 106.9284],
      zoom: 11,
      layers: [osm] // default layer
    });

    var redIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/484/484167.png',
      iconSize: [30, 30],
      iconAnchor: [15, 30],
      popupAnchor: [0, -25]
    });

    var markerLayer = L.layerGroup();
    var userReportLayer = L.layerGroup();
    var trafficIncidentLayer = L.layerGroup();
    var userReportIndex = {}; // _id -> marker
    var analysisMarker = null;
    var destinationMarker = null;
    var analysisLine = null;
    var analysisCircle = null;
    var analysisState = {
      mode: null,
      reference: null,
      destination: null,
      blackspotFC: turf.featureCollection([]),
      features: []
    };
    var referenceIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/854/854878.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    });
    var destinationIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
      iconSize: [28, 28],
      iconAnchor: [14, 28]
    });
    var highlightIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/484/484167.png',
      iconSize: [40, 40],
      iconAnchor: [20, 40]
    });
    var trafficIncidentIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/1828/1828843.png',
      iconSize: [28, 28],
      iconAnchor: [14, 28],
      popupAnchor: [0, -25]
    });
    var featureMarkerMap = {};
    var highlightedMarkerState = { marker: null, icon: null };
    var radiusIndicators = [];
    var nearestLine = null;
    function rebuildAnalysisCollection() {
      analysisState.blackspotFC = turf.featureCollection(analysisState.features.slice());
    }

    function setAnalysisFeatures(features) {
      analysisState.features = features.slice();
      rebuildAnalysisCollection();
    }

    function upsertAnalysisFeature(feature) {
      var uid = ensureFeatureId(feature);
      var idx = analysisState.features.findIndex(function(existing) {
        return ensureFeatureId(existing) === uid;
      });
      if (idx > -1) {
        analysisState.features[idx] = feature;
      } else {
        analysisState.features.push(feature);
      }
      rebuildAnalysisCollection();
    }

    function removeAnalysisFeature(uid) {
      if (!uid) return;
      analysisState.features = analysisState.features.filter(function(feature) {
        return ensureFeatureId(feature) !== uid;
      });
      rebuildAnalysisCollection();
    }

    function ensureFeatureId(feature) {
      if (!feature.properties) feature.properties = {};
      if (!feature.properties._uid) {
        var existing = feature.properties._id;
        feature.properties._uid = existing || ('feat_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 8));
      }
      return feature.properties._uid;
    }

    function registerMarker(feature, marker) {
      var uid = ensureFeatureId(feature);
      featureMarkerMap[uid] = marker;
      marker.__featureUid = uid;
      marker.__baseIcon = marker.__baseIcon || marker.options.icon;
    }

    function getMarkerByFeature(feature) {
      if (!feature || !feature.properties) return null;
      var uid = ensureFeatureId(feature);
      return featureMarkerMap[uid] || null;
    }

    function clearHighlightedMarker() {
      if (highlightedMarkerState.marker) {
        highlightedMarkerState.marker.setIcon(highlightedMarkerState.icon || highlightedMarkerState.marker.__baseIcon || redIcon);
        highlightedMarkerState.marker = null;
        highlightedMarkerState.icon = null;
      }
    }

    function highlightFeatureMarker(feature) {
      clearHighlightedMarker();
      var marker = getMarkerByFeature(feature);
      if (!marker) return;
      highlightedMarkerState.marker = marker;
      highlightedMarkerState.icon = marker.options.icon;
      marker.setIcon(highlightIcon);
      if (marker.getTooltip()) {
        marker.openTooltip();
      }
    }

    function clearRadiusIndicators() {
      radiusIndicators.forEach(function(popup) {
        map.removeLayer(popup);
      });
      radiusIndicators = [];
    }

    function showRadiusIndicators(features) {
      clearRadiusIndicators();
      features.forEach(function(feature) {
        var marker = getMarkerByFeature(feature);
        if (!marker) return;
        var popup = L.popup({
          closeButton: false,
          autoClose: false,
          closeOnClick: false,
          className: 'radius-popup'
        }).setLatLng(marker.getLatLng())
          .setContent('<strong>Masuk radius</strong><br>' + (feature.properties.nama || 'Titik'));
        popup.addTo(map);
        radiusIndicators.push(popup);
      });
    }

    function setAnalysisMessage(html) {
      document.getElementById('analysis-results').innerHTML = html;
    }

    function activateButtons(state) {
      document.getElementById('nearestBtn').disabled = !state.reference;
      document.getElementById('radiusBtn').disabled = !state.reference;
      document.getElementById('distanceBtn').disabled = !(state.reference && state.destination);
      document.getElementById('setDestinationBtn').disabled = !state.reference;
      document.getElementById('clearAnalysisBtn').disabled = !!(state.reference || state.destination);
    }

    function setReferencePoint(latlng) {
      if (analysisMarker) map.removeLayer(analysisMarker);
      analysisMarker = L.marker(latlng, { icon: referenceIcon, draggable: true }).addTo(map);
      analysisMarker.on('dragend', function(e) {
        var newLatLng = e.target.getLatLng();
        analysisState.reference = turf.point([newLatLng.lng, newLatLng.lat]);
        updateAnalysisArtifacts();
      });
      analysisState.reference = turf.point([latlng.lng, latlng.lat]);
      updateAnalysisArtifacts();
    }

    function setDestinationPoint(latlng, feature) {
      if (destinationMarker) map.removeLayer(destinationMarker);
      destinationMarker = L.marker(latlng, { icon: destinationIcon, draggable: true }).addTo(map);
      destinationMarker.on('dragend', function(e) {
        var newLatLng = e.target.getLatLng();
        analysisState.destination = turf.point([newLatLng.lng, newLatLng.lat]);
        drawDistanceLine();
      });
      analysisState.destination = turf.point([latlng.lng, latlng.lat]);
      if (nearestLine) {
        map.removeLayer(nearestLine);
        nearestLine = null;
      }
      drawDistanceLine();
      if (feature) {
        highlightFeatureMarker(feature);
      }
    }

    function updateAnalysisArtifacts() {
      if (analysisCircle) {
        map.removeLayer(analysisCircle);
        analysisCircle = null;
      }
      if (analysisLine) {
        map.removeLayer(analysisLine);
        analysisLine = null;
      }
      if (nearestLine) {
        map.removeLayer(nearestLine);
        nearestLine = null;
      }
      clearRadiusIndicators();
      clearHighlightedMarker();
      analysisState.destination = null;
      if (destinationMarker) {
        map.removeLayer(destinationMarker);
        destinationMarker = null;
      }
      activateButtons(analysisState);
      setAnalysisMessage('<p>Penanda referensi tersimpan. Silakan jalankan analisis.</p>');
    }

    function drawDistanceLine() {
      if (analysisLine) {
        map.removeLayer(analysisLine);
      }
      if (!(analysisState.reference && analysisState.destination)) {
        activateButtons(analysisState);
        return;
      }
      var start = analysisState.reference.geometry.coordinates;
      var end = analysisState.destination.geometry.coordinates;
      analysisLine = L.polyline([[start[1], start[0]], [end[1], end[0]]], {
        color: '#f97316',
        dashArray: '8,6',
        weight: 4
      }).addTo(map);
      activateButtons(analysisState);
    }

    function handleAnalysisClick(e) {
      if (!analysisState.mode) return;
      if (analysisState.mode === 'reference') {
        setReferencePoint(e.latlng);
        setAnalysisMessage('<p>Penanda referensi ditetapkan dari klik peta.</p>');
      } else if (analysisState.mode === 'destination') {
        setDestinationPoint(e.latlng);
        setAnalysisMessage('<p>Tujuan ditetapkan dari klik peta. Jalankan perhitungan jarak.</p>');
      }
      analysisState.mode = null;
      map.getContainer().style.cursor = '';
    }

    function promptRadius() {
      var radiusInput = document.getElementById('radiusInput');
      var value = parseFloat(radiusInput.value);
      if (Number.isNaN(value) || value <= 0) {
        alert('Radius harus berupa angka lebih dari 0');
        return null;
      }
      return value;
    }

    function runNearestAnalysis() {
      if (!(analysisState.reference && analysisState.blackspotFC && analysisState.blackspotFC.features.length)) {
        setAnalysisMessage('<p>Data belum lengkap untuk analisis.</p>');
        return;
      }
      var nearest = turf.nearestPoint(analysisState.reference, analysisState.blackspotFC);
      if (!nearest) {
        setAnalysisMessage('<p>Tidak ada titik blackspot.</p>');
        return;
      }
      var distance = turf.distance(analysisState.reference, nearest, { units: 'kilometers' }).toFixed(2);
      var coords = nearest.geometry.coordinates;
      setAnalysisMessage(`
        <p><strong>Titik terdekat</strong>: ${nearest.properties.nama || 'Tanpa nama'}.</p>
        <p>Jarak: ${distance} km.</p>
        <p>Koordinat: ${coords[1].toFixed(5)}, ${coords[0].toFixed(5)}</p>
      `);
      clearRadiusIndicators();
      if (nearestLine) {
        map.removeLayer(nearestLine);
      }
      nearestLine = L.polyline([
        [analysisState.reference.geometry.coordinates[1], analysisState.reference.geometry.coordinates[0]],
        [coords[1], coords[0]]
      ], {
        color: '#f43f5e',
        weight: 4,
        dashArray: '6,4'
      }).addTo(map);
      highlightFeatureMarker(nearest);
      map.setView([coords[1], coords[0]], 14);
    }

    function runRadiusAnalysis() {
      var radius = promptRadius();
      if (!radius || !analysisState.reference || !analysisState.blackspotFC || !analysisState.blackspotFC.features.length) {
        setAnalysisMessage('<p>Data belum lengkap untuk analisis radius.</p>');
        return;
      }
      if (analysisCircle) map.removeLayer(analysisCircle);
      analysisCircle = L.circle([analysisState.reference.geometry.coordinates[1], analysisState.reference.geometry.coordinates[0]], {
        radius: radius * 1000,
        color: '#10b981',
        fillColor: '#10b981',
        fillOpacity: 0.15
      }).addTo(map);
      var within = analysisState.blackspotFC.features.filter(function(feature) {
        var dist = turf.distance(analysisState.reference, feature, { units: 'kilometers' });
        return dist <= radius;
      });
      if (!within.length) {
        setAnalysisMessage(`<p>Tidak ada titik dalam radius ${radius} km.</p>`);
        return;
      }
      clearHighlightedMarker();
      var listItems = within.map(function(feature) {
        var d = turf.distance(analysisState.reference, feature, { units: 'kilometers' }).toFixed(2);
        return `<li>${feature.properties.nama || 'Tanpa nama'} - ${d} km</li>`;
      }).join('');
      showRadiusIndicators(within);
      setAnalysisMessage(`
        <p><strong>${within.length}</strong> titik dalam radius ${radius} km:</p>
        <ul>${listItems}</ul>
      `);
    }

    function runDistanceAnalysis() {
      if (!(analysisState.reference && analysisState.destination)) {
        setAnalysisMessage('<p>Pilih titik referensi dan tujuan terlebih dahulu.</p>');
        return;
      }
      var distance = turf.distance(analysisState.reference, analysisState.destination, { units: 'kilometers' }).toFixed(2);
      setAnalysisMessage(`
        <p>Jarak tempuh garis lurus antara referensi dan tujuan: <strong>${distance} km</strong>.</p>
        <p>Dongkrak ketelitian dengan memindahkan marker menggunakan drag & drop.</p>
      `);
    }

    function reportDistanceToFeature(feature) {
      if (!analysisState.reference || !feature || !feature.geometry) return;
      var dist = turf.distance(analysisState.reference, feature, { units: 'kilometers' }).toFixed(2);
      var message = `
        <p>Jarak penanda referensi ke <strong>${feature.properties.nama || 'titik'}</strong> adalah ${dist} km.</p>
      `;
      setAnalysisMessage(message);
    }

    function clearAnalysis() {
      if (analysisMarker) { map.removeLayer(analysisMarker); analysisMarker = null; }
      if (destinationMarker) { map.removeLayer(destinationMarker); destinationMarker = null; }
      if (analysisLine) { map.removeLayer(analysisLine); analysisLine = null; }
      if (nearestLine) { map.removeLayer(nearestLine); nearestLine = null; }
      if (analysisCircle) { map.removeLayer(analysisCircle); analysisCircle = null; }
      analysisState.reference = null;
      analysisState.destination = null;
      analysisState.mode = null;
      map.getContainer().style.cursor = '';
      clearRadiusIndicators();
      clearHighlightedMarker();
      activateButtons(analysisState);
      setAnalysisMessage('<p>Set penanda referensi untuk memulai analisis spasial.</p>');
    }

    map.on('click', handleAnalysisClick);

    var referenceBtn = document.getElementById('setReferenceBtn');
    var destinationBtn = document.getElementById('setDestinationBtn');
    var nearestBtn = document.getElementById('nearestBtn');
    var radiusBtn = document.getElementById('radiusBtn');
    var distanceBtn = document.getElementById('distanceBtn');
    var clearBtn = document.getElementById('clearAnalysisBtn');
    activateButtons(analysisState);

    referenceBtn.addEventListener('click', function() {
      analysisState.mode = 'reference';
      map.getContainer().style.cursor = 'crosshair';
      setAnalysisMessage('<p>Klik di peta untuk menetapkan penanda referensi.</p>');
    });

    destinationBtn.addEventListener('click', function() {
      if (!analysisState.reference) {
        alert('Tetapkan penanda referensi terlebih dahulu.');
        return;
      }
      analysisState.mode = 'destination';
      map.getContainer().style.cursor = 'crosshair';
      setAnalysisMessage('<p>Klik lokasi tujuan di peta.</p>');
    });

    nearestBtn.addEventListener('click', runNearestAnalysis);
    radiusBtn.addEventListener('click', runRadiusAnalysis);
    distanceBtn.addEventListener('click', runDistanceAnalysis);
    clearBtn.addEventListener('click', clearAnalysis);

    // ===============================
    // UTIL: RENDER & STORAGE LAPORAN PENGGUNA
    // ===============================
    function featureToMarker(feature, latlngOverride) {
      var coords = feature.geometry && feature.geometry.coordinates;
      if (!coords || coords.length < 2) return null;
      var latlng = latlngOverride || L.latLng(coords[1], coords[0]);
      var marker = L.marker(latlng, { icon: redIcon });
      registerMarker(feature, marker);
      var name = (feature.properties && feature.properties.nama) || 'Laporan Pengguna';
      marker.bindTooltip(name);
      marker.on('click', function() {
        if (analysisState.mode === 'reference') {
          setReferencePoint(marker.getLatLng());
          analysisState.mode = null;
          map.getContainer().style.cursor = '';
          setAnalysisMessage('<p>Penanda referensi diambil dari marker.</p>');
          return;
        }
        if (analysisState.mode === 'destination') {
          setDestinationPoint(marker.getLatLng(), feature);
          analysisState.mode = null;
          map.getContainer().style.cursor = '';
          setAnalysisMessage('<p>Titik tujuan diambil dari marker terpilih.</p>');
          return;
        }
        updateSidebar(feature);
        map.setView(latlng, 14);
        reportDistanceToFeature(feature);
      });
      return marker;
    }

    function addUserReportFeature(feature) {
      ensureFeatureId(feature);
      if (!feature.properties) feature.properties = {};
      if (!feature.properties._id) {
        feature.properties._id = 'rep_' + Date.now().toString(36) + Math.random().toString(36).slice(2,8);
      }
      feature.properties._user = true;
      var marker = featureToMarker(feature);
      if (marker) {
        marker.addTo(userReportLayer);
        userReportIndex[feature.properties._id] = marker;
        upsertAnalysisFeature(feature);
      }
    }

    function loadUserReports() {
      try {
        var raw = localStorage.getItem('userReports');
        if (!raw) return;
        var geojson = JSON.parse(raw);
        if (!geojson || !Array.isArray(geojson.features)) return;
        geojson.features.forEach(addUserReportFeature);
      } catch (e) {
        console.warn('Gagal memuat laporan pengguna dari localStorage', e);
      }
    }

    function saveUserReport(feature) {
      ensureFeatureId(feature);
      var collection = { type: 'FeatureCollection', features: [] };
      try {
        var raw = localStorage.getItem('userReports');
        if (raw) {
          var parsed = JSON.parse(raw);
          if (parsed && Array.isArray(parsed.features)) collection.features = parsed.features;
        }
      } catch (e) {
        // mulai koleksi baru jika parsing gagal
      }
      if (!feature.properties) feature.properties = {};
      if (!feature.properties._id) {
        feature.properties._id = 'rep_' + Date.now().toString(36) + Math.random().toString(36).slice(2,8);
      }
      feature.properties._user = true;
      collection.features.push(feature);
      localStorage.setItem('userReports', JSON.stringify(collection));
    }

    function updateSidebar(feature) {
      var props = feature.properties || {};
      var container = document.getElementById('sidebar-content');
      container.innerHTML = `
        <div class="info-card">
          <h3 class="info-title">${props.nama || 'Lokasi Tanpa Nama'}</h3>
          <div class="summary">
            <div class="summary-item"><div class="summary-label">Jenis</div><div class="summary-value">${(props.kecelakaan || '-').split(' ')[0]}</div></div>
            <div class="summary-item"><div class="summary-label">Korban</div><div class="summary-value">${props.korban ? props.korban.split(',')[0] : '-'}</div></div>
            <div class="summary-item"><div class="summary-label">Waktu</div><div class="summary-value">${props.waktu ? props.waktu.split(',')[0] : '-'}</div></div>
          </div>
          <div class="kv">
            <div class="kv-row"><span class="kv-label">Jenis Kejadian</span><span class="kv-value">${props.kecelakaan || '-'}</span></div>
            <div class="kv-row"><span class="kv-label">Korban</span><span class="kv-value">${props.korban || '-'}</span></div>
            <div class="kv-row"><span class="kv-label">Waktu</span><span class="kv-value">${props.waktu || '-'}</span></div>
            <div class="kv-row"><span class="kv-label">Koordinat</span><span class="kv-value">${(feature.geometry && feature.geometry.coordinates) ? feature.geometry.coordinates[1].toFixed(5) + ', ' + feature.geometry.coordinates[0].toFixed(5) : '-'}</span></div>
          </div>
          <div class="divider"></div>
          <p class="muted">Ringkasan lokasi blackspot. Pilih titik lain di peta untuk melihat detail berbeda.</p>
        </div>
      `;
      var reportBtn = document.getElementById('reportBtn');
      var deleteBtn = document.getElementById('deleteBtn');
      reportBtn.disabled = false;
      reportBtn.innerHTML = '\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14M5 12h14" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>\n        Tambah Laporan\n      ';
      // Atur tombol Hapus: hanya aktif untuk laporan pengguna
      if (props._user && props._id) {
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = '\n        Hapus Laporan\n      ';
        deleteBtn.onclick = function() {
          if (!confirm('Hapus laporan ini?')) return;
          try {
            var raw = localStorage.getItem('userReports');
            var collection = raw ? JSON.parse(raw) : { type: 'FeatureCollection', features: [] };
            collection.features = (collection.features || []).filter(function(f) {
              return !(f && f.properties && f.properties._id === props._id);
            });
            localStorage.setItem('userReports', JSON.stringify(collection));

            // Hapus marker dari peta jika ada
            var marker = userReportIndex[props._id];
            if (marker) {
              userReportLayer.removeLayer(marker);
              delete userReportIndex[props._id];
            }

            removeAnalysisFeature(props._uid || props._id);
            if (highlightedMarkerState.marker && highlightedMarkerState.marker.__featureUid === (props._uid || props._id)) {
              highlightedMarkerState.marker = null;
              highlightedMarkerState.icon = null;
            }

            // Reset sidebar ke placeholder
            document.getElementById('sidebar-content').innerHTML = '\n        <div class="placeholder">\n          <div class="dot"></div>\n          <p>Pilih marker pada peta untuk menampilkan ringkasan kecelakaan.</p>\n        </div>\n      ';
            deleteBtn.disabled = true;
          } catch (e) {
            alert('Gagal menghapus laporan.');
          }
        };
      } else {
        deleteBtn.disabled = true;
        deleteBtn.onclick = null;
      }

      reportBtn.onclick = function() {
        var originalLabel = reportBtn.innerHTML;
        reportBtn.disabled = true;
        reportBtn.innerHTML = '\n        Pilih lokasi di peta...\n      ';

        var clickOnce = function(e) {
          map.off('click', clickOnce);
          var latlng = e.latlng;
          var nama = prompt('Nama lokasi/kejadian:', props.nama || 'Laporan Pengguna');
          if (nama === null) { reportBtn.disabled = false; reportBtn.innerHTML = originalLabel; return; }
          var jenis = prompt('Jenis kejadian (mis. Tabrakan beruntun):', props.kecelakaan || 'Kecelakaan');
          if (jenis === null) { reportBtn.disabled = false; reportBtn.innerHTML = originalLabel; return; }
          var korban = prompt('Korban (mis. 1 meninggal, 2 luka):', props.korban || '0 meninggal, 0 luka');
          if (korban === null) { reportBtn.disabled = false; reportBtn.innerHTML = originalLabel; return; }
          var waktu = prompt('Waktu (mis. 12 Nov 2025, 14:30):', props.waktu || new Date().toLocaleString());
          if (waktu === null) { reportBtn.disabled = false; reportBtn.innerHTML = originalLabel; return; }

          var feature = {
            type: 'Feature',
            properties: { nama: nama, kecelakaan: jenis, korban: korban, waktu: waktu },
            geometry: { type: 'Point', coordinates: [latlng.lng, latlng.lat] }
          };

          addUserReportFeature(feature);
          saveUserReport(feature);
          updateSidebar(feature);

          reportBtn.disabled = false;
          reportBtn.innerHTML = originalLabel;
        };

        map.on('click', clickOnce);
      };

      reportDistanceToFeature(feature);
    }

    // ===============================
    // POLYLINE (JALUR JALAN UTAMA)
    // ===============================
    var polylineLayer = L.polyline([
      [-6.9218, 106.9425],
      [-6.933, 106.975],
      [-6.941, 106.898],
      [-6.879, 106.842],
      [-6.823, 106.783]
    ], {
      color: 'blue',
      weight: 4,
      opacity: 0.7
    }).bindPopup("Jalur utama penghubung antar kecamatan");

    // ===============================
    // POLYGON (BATAS KECAMATAN DUMMY)
    // ===============================
    var polygonLayer = L.polygon([
      [-6.89, 106.90],
      [-6.92, 106.97],
      [-6.96, 106.95],
      [-6.94, 106.88]
    ], {
      color: 'green',
      fillColor: '#00FF00',
      fillOpacity: 0.2
    }).bindPopup("Batas wilayah Kecamatan Sukaraja (contoh)");

    // ===============================
    // KONTROL LAYER
    // ===============================
    var baseMaps = {
      "OpenStreetMap": osm,
      "Satellite": satellite
    };

    var overlayMaps = {
      "Titik Blackspot": markerLayer,
      "Laporan Pengguna": userReportLayer,
      "Insiden Lalu Lintas (TomTom)": trafficIncidentLayer,
      "Jalur Utama": polylineLayer,
      "Batas Kecamatan": polygonLayer
    };

    L.control.layers(baseMaps, overlayMaps).addTo(map);

    // Default tampil semua overlay
    markerLayer.addTo(map);
    polylineLayer.addTo(map);
    polygonLayer.addTo(map);
    userReportLayer.addTo(map);

    // ===============================
    // TOMTOM TRAFFIC API INTEGRATION
    // ===============================
    // Utility function to escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // API key TomTom
    var TOMTOM_API_KEY = '4CZMpEqq9NEItsBXz1h0bshCz1RArdEs';
    
    // Update traffic status display
    function updateTrafficStatus(message, isError) {
      var statusEl = document.getElementById('trafficStatus');
      if (statusEl) {
        statusEl.textContent = message;
        statusEl.style.color = isError ? '#dc2626' : '#6b7280';
      }
    }
    
    function getTrafficIncidents() {
      // Periksa apakah API key sudah diatur dengan benar
      var apiKey = (TOMTOM_API_KEY || '').trim();
      if (!apiKey || apiKey === '' || apiKey === 'YOUR_TOMTOM_API_KEY_HERE' || apiKey === 'YOUR_API_KEY') {
        updateTrafficStatus('âš ï¸ API key belum diatur', true);
        console.warn('TomTom API key belum diatur. Silakan set TOMTOM_API_KEY di kode dengan API key yang valid.');
        return;
      }
      
      updateTrafficStatus('Memuat insiden...', false);
      
      var url = 'https://api.tomtom.com/traffic/services/5/incidentDetails' +
        '?bbox=106.27,-7.38,107.07,-6.57' +
        '&fields={incidents{type,geometry{type,coordinates},properties{iconCategory}}}' +
        '&language=en-GB' +
        '&categoryFilter=1' +
        '&timeValidityFilter=present' +
        '&key=' + apiKey;
      
      fetch(url)
        .then(function(response) {
          if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
          }
          return response.json();
        })
        .then(function(data) {
          // Clear existing traffic incidents
          trafficIncidentLayer.clearLayers();
          
          // TomTom API returns data in different formats, handle both
          var incidents = [];
          if (data && data.incidents && Array.isArray(data.incidents)) {
            incidents = data.incidents;
          } else if (data && Array.isArray(data)) {
            incidents = data;
          } else if (data && data.tm && data.tm.poi && Array.isArray(data.tm.poi)) {
            incidents = data.tm.poi;
          }
          
          if (incidents.length === 0) {
            updateTrafficStatus('Tidak ada insiden ditemukan', false);
            console.log('Tidak ada insiden lalu lintas ditemukan.');
            return;
          }
          
          var incidentCount = 0;
          incidents.forEach(function(incident) {
            try {
              if (!incident.geometry || !incident.geometry.coordinates) return;
              
              var coords = incident.geometry.coordinates;
              var lat, lng;
              
              // Handle different geometry types
              if (incident.geometry.type === 'Point') {
                lng = coords[0];
                lat = coords[1];
              } else if (incident.geometry.type === 'LineString' && Array.isArray(coords) && coords.length > 0) {
                // Use first point of LineString
                if (Array.isArray(coords[0])) {
                  lng = coords[0][0];
                  lat = coords[0][1];
                } else {
                  lng = coords[0];
                  lat = coords[1];
                }
              } else {
                return; // Skip if we can't determine coordinates
              }
              
              // Validate coordinates
              if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                return;
              }
              
              var incidentType = incident.type || 'Unknown';
              var iconCategory = (incident.properties && incident.properties.iconCategory) || 
                                 (incident.poi && incident.poi.classifications && incident.poi.classifications[0]) ||
                                 'Unknown';
              
              // Get additional properties if available
              var severity = (incident.properties && incident.properties.severity) || 
                            (incident.poi && incident.poi.severity) || '';
              var description = (incident.properties && incident.properties.description) || 
                               (incident.poi && incident.poi.description) || '';
              
              // Create marker for incident
              var marker = L.marker([lat, lng], { icon: trafficIncidentIcon });
              
              // Create popup content
              var popupContent = '<div class="popup-content">' +
                '<h4 style="margin: 0 0 8px; color: #dc2626;">ðŸš¨ Insiden Lalu Lintas</h4>' +
                '<p style="margin: 4px 0;"><strong>Jenis:</strong> ' + escapeHtml(incidentType) + '</p>';
              
              if (iconCategory && iconCategory !== 'Unknown') {
                popupContent += '<p style="margin: 4px 0;"><strong>Kategori:</strong> ' + escapeHtml(iconCategory) + '</p>';
              }
              
              if (severity) {
                popupContent += '<p style="margin: 4px 0;"><strong>Tingkat Keparahan:</strong> ' + escapeHtml(severity) + '</p>';
              }
              
              if (description) {
                popupContent += '<p style="margin: 4px 0;"><strong>Deskripsi:</strong> ' + escapeHtml(description) + '</p>';
              }
              
              popupContent += '<p style="margin: 4px 0; font-size: 12px; color: #6b7280;">Koordinat: ' + 
                lat.toFixed(5) + ', ' + lng.toFixed(5) + '</p>' +
                '</div>';
              
              marker.bindPopup(popupContent);
              marker.bindTooltip('Insiden: ' + incidentType);
              
              // Add click handler
              marker.on('click', function() {
                map.setView([lat, lng], 14);
              });
              
              marker.addTo(trafficIncidentLayer);
              incidentCount++;
            } catch (e) {
              console.warn('Error processing incident:', e, incident);
            }
          });
          
          updateTrafficStatus('âœ“ ' + incidentCount + ' insiden dimuat', false);
          console.log('Memuat ' + incidentCount + ' insiden lalu lintas dari TomTom API.');
        })
        .catch(function(error) {
          console.error('Error fetching traffic incidents:', error);
          var errorMsg = 'Error memuat insiden';
          if (error.message.includes('401') || error.message.includes('403')) {
            errorMsg = 'API key tidak valid';
          } else if (error.message.includes('CORS')) {
            errorMsg = 'Error CORS - cek konfigurasi server';
          }
          updateTrafficStatus('âœ— ' + errorMsg, true);
        });
    }
    
    // Add refresh button event listener
    var refreshTrafficBtn = document.getElementById('refreshTrafficBtn');
    if (refreshTrafficBtn) {
      refreshTrafficBtn.addEventListener('click', function() {
        getTrafficIncidents();
      });
    }
    
    // Load traffic incidents on page load
    getTrafficIncidents();
    
    // Refresh traffic incidents every 5 minutes
    setInterval(getTrafficIncidents, 5 * 60 * 1000);

    // ===============================
    // MUAT DATA GEOJSON DARI FILE
    // ===============================
    fetch('data/blackspot.geojson')
      .then(function(res) { return res.json(); })
      .then(function(blackspotData) {
        var baseFeatures = (blackspotData.features || []);
        baseFeatures.forEach(ensureFeatureId);
        setAnalysisFeatures(baseFeatures);
        activateButtons(analysisState);
        var geoLayer = L.geoJSON(blackspotData, {
          pointToLayer: function(feature, latlng) {
            var marker = L.marker(latlng, { icon: redIcon });
            registerMarker(feature, marker);
            return marker;
          },
          onEachFeature: function(feature, layer) {
            layer.bindTooltip(feature.properties.nama);
            layer.on('click', function() {
              updateSidebar(feature);
              map.setView(layer.getLatLng(), 14);
              reportDistanceToFeature(feature);
            });
          }
        });
        geoLayer.addTo(markerLayer);

        // Pilih satu data pertama untuk ditampilkan di sidebar saat awal
        if (blackspotData.features && blackspotData.features.length > 0) {
          updateSidebar(blackspotData.features[0]);
        }

        // Muat laporan pengguna dari localStorage
        loadUserReports();
      })
      .catch(function(err) {
        console.error('Gagal memuat data GeoJSON:', err);
      });
  </script>
</body>
</html>