<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <title>GIS Blackspot Sukabumi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="assets/styles.css" />
</head>

<body>

  <!-- Map Container -->
  <div id="map"></div>

  <!-- Traffic Status Overlay -->
  <div class="overlay-status glass-panel">
    <span id="trafficStatus">Memuat data map...</span>
  </div>

  <!-- App Shell -->
  <div class="app-shell">

    <!-- Navigation Rail -->
    <nav class="nav-rail glass-panel clickable">
      <div class="nav-logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
        </svg>
      </div>

      <button class="nav-btn active" id="navHome" title="Beranda" onclick="switchPanel('home')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
      </button>

      <button class="nav-btn" id="navAnalysis" title="Analisis Spasial" onclick="switchPanel('analysis')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
          stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="2" y1="12" x2="22" y2="12"></line>
          <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
        </svg>
      </button>

      <button class="nav-btn" id="navLayers" title="Filter Layer" onclick="switchPanel('layers')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
          stroke-linecap="round" stroke-linejoin="round">
          <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
          <polyline points="2 17 12 22 22 17"></polyline>
          <polyline points="2 12 12 17 22 12"></polyline>
        </svg>
      </button>
    </nav>

    <!-- Side Panel (Analysis/Home/Layers) -->
    <aside id="mainPanel" class="panel-drawer glass-panel clickable">

      <!-- Home Content -->
      <div id="panel-home" class="panel-view">
        <div class="panel-header">
          <h2 class="panel-title">Blackspot GIS</h2>
          <p class="panel-subtitle">Kabupaten Sukabumi</p>
        </div>
        <div class="panel-content">
          <p style="color:var(--text-muted); font-size:14px; margin-bottom:24px;">
            Sistem Informasi Geografis untuk pemetaan dan analisis daerah rawan kecelakaan. Gunakan menu navigasi untuk
            mengakses fitur analisis.
          </p>

          <div class="control-group">
            <span class="control-label">Ringkasan Sistem</span>
            <div class="row">
              <div class="info-box">
                <span class="ib-label">Total Data</span>
                <span class="ib-value" id="stats-total">-</span>
              </div>
              <div class="info-box">
                <span class="ib-label">Incident TomTom</span>
                <span class="ib-value" id="stats-tomtom">-</span>
              </div>
            </div>
          </div>

          <div class="control-group">
            <span class="control-label">Aksi Cepat</span>
            <button id="addReportBtnMain" class="btn btn-primary">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14" />
              </svg>
              Lapor Kejadian Baru
            </button>
          </div>

        </div>
      </div>

      <!-- Analysis Content -->
      <div id="panel-analysis" class="panel-view hidden">
        <div class="panel-header">
          <h2 class="panel-title">Analisis Spasial</h2>
          <p class="panel-subtitle">Perhitungan jarak dan radius blackspot</p>
        </div>
        <div class="panel-content">

          <div class="control-group">
            <span class="control-label">1. Tentukan Titik</span>
            <div class="row">
              <button id="setReferenceBtn" class="btn btn-primary">Titik Acuan</button>
              <button id="setDestinationBtn" class="btn btn-secondary">Titik Tujuan</button>
            </div>
            <p id="analysis-instruction" style="font-size:12px; color:var(--text-muted); margin-top:8px;">Klik tombol
              lalu klik pada peta.</p>
          </div>

          <div class="control-group">
            <span class="control-label">2. Operasi</span>
            <div class="row">
              <button id="nearestBtn" class="btn btn-secondary" disabled>Cari Terdekat</button>
              <button id="distanceBtn" class="btn btn-secondary" disabled>Cek Jarak</button>
            </div>
            <div style="margin-top:12px;">
              <span class="control-label" style="margin-bottom:6px;">Radius (KM)</span>
              <div style="display:flex; gap:8px;">
                <input type="number" id="radiusInput" value="2" step="0.5" style="width:80px;">
                <button id="radiusBtn" class="btn btn-secondary" disabled style="flex:1;">Scan Radius</button>
              </div>
            </div>
          </div>

          <div class="control-group">
            <button id="clearAnalysisBtn" class="btn btn-danger" disabled>Reset Analisis</button>
          </div>

          <div class="control-group">
            <span class="control-label">Hasil Analisis</span>
            <div id="analysis-results" style="font-size:13px; color:var(--text-muted);">
              Belum ada analisis yang dijalankan.
            </div>
          </div>

        </div>
      </div>

      <!-- Layers Content (Dummy placeholder layout) -->
      <div id="panel-layers" class="panel-view hidden">
        <div class="panel-header">
          <h2 class="panel-title">Manajemen Layer</h2>
          <p class="panel-subtitle">Atur visibilitas data peta</p>
        </div>
        <div class="panel-content">
          <div id="custom-layer-control">
            <!-- Leaflet default control will be styled, or we could move it here customly -->
            <p style="font-size:13px; color:var(--text-muted);">Gunakan kontrol layer di pojok kanan atas peta untuk
              mengganti base map dan overlay.</p>
            <button id="refreshTrafficBtn" class="btn btn-secondary small" style="margin-top:16px;">
              ðŸ”„ Refresh TomTom Traffic
            </button>
          </div>
        </div>
      </div>

    </aside>

    <!-- Detail Drawer (Right) -->
    <aside id="detailDrawer" class="detail-drawer glass-panel clickable">

      <div class="detail-header-img">
        <button onclick="closeDetail()"
          style="position:absolute; top:12px; right:12px; background:rgba(0,0,0,0.3); border:none; border-radius:50%; width:32px; height:32px; color:fff; cursor:pointer;">âœ•</button>
        <div class="detail-header-content">
          <span class="detail-tag" id="detail-type">KECELAKAAN</span>
          <h2 style="margin:8px 0 0; color:white; text-shadow:0 2px 4px rgba(0,0,0,0.5);" id="detail-title">Nama Lokasi
          </h2>
        </div>
      </div>

      <div class="panel-content">
        <div class="info-grid">
          <div class="info-box">
            <span class="ib-label">Waktu Kejadian</span>
            <span class="ib-value" id="detail-time">-</span>
          </div>
          <div class="info-box">
            <span class="ib-label">Korban Jiwa</span>
            <span class="ib-value" id="detail-victim">-</span>
          </div>
        </div>

        <div style="margin-top:24px;">
          <span class="control-label">Keterangan</span>
          <p style="font-size:14px; line-height:1.6; color:var(--text-muted);" id="detail-desc">
            Tidak ada keterangan tambahan untuk lokasi ini.
          </p>
        </div>

        <div style="margin-top:auto; padding-top:24px; display:flex; gap:12px;">
          <button id="deleteReportBtn" class="btn btn-danger hidden">Hapus Laporan</button>
        </div>
      </div>

    </aside>

  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <script>
    // --- UI Logic ---
    function switchPanel(panelId) {
      // Nav states
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      if (panelId === 'home') document.getElementById('navHome').classList.add('active');
      if (panelId === 'analysis') document.getElementById('navAnalysis').classList.add('active');
      if (panelId === 'layers') document.getElementById('navLayers').classList.add('active');

      // Panel visibility
      document.querySelectorAll('.panel-view').forEach(p => p.classList.add('hidden'));
      document.getElementById('panel-' + panelId).classList.remove('hidden');

      // Open drawer
      const drawer = document.getElementById('mainPanel');
      if (!drawer.classList.contains('open')) drawer.classList.add('open');
    }

    function closeDetail() {
      document.getElementById('detailDrawer').classList.remove('open');
    }

    function openDetail() {
      document.getElementById('detailDrawer').classList.add('open');
    }

    // Initialize UI
    setTimeout(() => document.getElementById('mainPanel').classList.add('open'), 500);

    // --- MAP & GIS Logic (Ported from Original) ---

    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap'
    });

    var satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      maxZoom: 20,
      subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
      attribution: 'Â© Google Satellite'
    });

    // Dark Map Style for modern look (using CartoDB DarkMatter as alternative base if wanted, keeping OSM for now but stylized via CSS opacity is option. Let's stick to standard tiles but map container has bg)

    var map = L.map('map', {
      center: [-6.9241, 106.9284],
      zoom: 11,
      zoomControl: false, // Reposition zoom later
      layers: [osm]
    });

    L.control.zoom({ position: 'bottomright' }).addTo(map);

    var redIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/484/484167.png',
      iconSize: [30, 30],
      iconAnchor: [15, 30],
      popupAnchor: [0, -25]
    });

    var markerLayer = L.layerGroup();
    var userReportLayer = L.layerGroup();
    var trafficIncidentLayer = L.layerGroup();
    var heatmapLayer = null;

    // Analysis State
    var analysisState = {
      mode: null,
      reference: null,
      destination: null,
      blackspotFC: turf.featureCollection([]),
      features: []
    };

    var analysisMarker, destinationMarker, analysisLine, analysisCircle, nearestLine;

    var featureMarkerMap = {}; // uid -> marker

    // --- Helper Functions ---

    function updateStats() {
      // Simple stats update
      var count = analysisState.features.length;
      document.getElementById('stats-total').innerText = count + " Lokasi";
    }

    function setAnalysisMessage(html) {
      document.getElementById('analysis-results').innerHTML = html;
    }

    function activateButtons() {
      const s = analysisState;
      document.getElementById('nearestBtn').disabled = !s.reference;
      document.getElementById('radiusBtn').disabled = !s.reference;
      document.getElementById('distanceBtn').disabled = !(s.reference && s.destination);
      document.getElementById('setDestinationBtn').disabled = !s.reference;
      document.getElementById('clearAnalysisBtn').disabled = !(s.reference || s.destination);
    }

    // --- Detail Drawer Logic ---
    var activeFeatureId = null;

    function updateDetailDrawer(feature) {
      const p = feature.properties || {};

      document.getElementById('detail-title').innerText = p.nama || 'Lokasi Tanpa Nama';
      document.getElementById('detail-type').innerText = (p.kecelakaan || 'Info').toUpperCase();

      // Parse more info
      document.getElementById('detail-time').innerText = p.waktu || '-';
      document.getElementById('detail-victim').innerText = p.korban || '-';

      const coords = feature.geometry.coordinates;
      const coordText = coords ? coords[1].toFixed(5) + ', ' + coords[0].toFixed(5) : '-';

      document.getElementById('detail-desc').innerHTML = `
         <strong>Koordinat:</strong> ${coordText}<br><br>
         Data ini tercatat dalam sistem informasi geografis blackspot.
       `;

      // User report handling
      const delBtn = document.getElementById('deleteReportBtn');
      if (p._user && p._id) {
        activeFeatureId = p._id;
        delBtn.classList.remove('hidden');
        delBtn.onclick = () => deleteUserReport(p._id);
      } else {
        activeFeatureId = null;
        delBtn.classList.add('hidden');
      }

      openDetail();
    }

    // --- Analysis Functions ---

    function setReferencePoint(latlng) {
      if (analysisMarker) map.removeLayer(analysisMarker);
      analysisMarker = L.marker(latlng, { draggable: true }).addTo(map).bindTooltip("Titik Acuan").openTooltip();

      analysisMarker.on('dragend', function (e) {
        analysisState.reference = turf.point([e.target.getLatLng().lng, e.target.getLatLng().lat]);
        activateButtons();
      });

      analysisState.reference = turf.point([latlng.lng, latlng.lat]);
      activateButtons();
      setAnalysisMessage('<span style="color:var(--success)">Titik acuan ditetapkan.</span> Pilih operasi analisis.');

      // Auto switch to analysis panel if not open
      switchPanel('analysis');
    }

    function setDestinationPoint(latlng) {
      if (destinationMarker) map.removeLayer(destinationMarker);
      destinationMarker = L.marker(latlng, { draggable: true }).addTo(map).bindTooltip("Tujuan").openTooltip();

      destinationMarker.on('dragend', function (e) {
        analysisState.destination = turf.point([e.target.getLatLng().lng, e.target.getLatLng().lat]);
        drawDistanceLine();
      });

      analysisState.destination = turf.point([latlng.lng, latlng.lat]);
      drawDistanceLine();
    }

    function drawDistanceLine() {
      if (analysisLine) map.removeLayer(analysisLine);
      if (nearestLine) map.removeLayer(nearestLine);

      if (analysisState.reference && analysisState.destination) {
        var from = analysisState.reference.geometry.coordinates;
        var to = analysisState.destination.geometry.coordinates;

        analysisLine = L.polyline([[from[1], from[0]], [to[1], to[0]]], {
          color: '#f59e0b', weight: 4, dashArray: '10,10'
        }).addTo(map);

        var d = turf.distance(analysisState.reference, analysisState.destination, { units: 'kilometers' }).toFixed(2);
        setAnalysisMessage(`Jarak lurus: <strong style="color:white; font-size:16px;">${d} KM</strong>`);
        activateButtons();
      }
    }

    function runNearest() {
      if (!analysisState.reference || analysisState.features.length === 0) return;

      var nearest = turf.nearestPoint(analysisState.reference, analysisState.blackspotFC);
      if (nearest) {
        var c = nearest.geometry.coordinates;
        if (nearestLine) map.removeLayer(nearestLine);

        var refC = analysisState.reference.geometry.coordinates;
        nearestLine = L.polyline([[refC[1], refC[0]], [c[1], c[0]]], { color: '#ef4444', weight: 4 }).addTo(map);

        var d = turf.distance(analysisState.reference, nearest, { units: 'kilometers' }).toFixed(2);
        setAnalysisMessage(`Titik Terdekat: <strong>${nearest.properties.nama}</strong> (${d} KM)`);
        map.setView([c[1], c[0]], 14);
        updateDetailDrawer(nearest);
      }
    }

    function runRadius() {
      var r = parseFloat(document.getElementById('radiusInput').value);
      if (!r || !analysisState.reference) return;

      if (analysisCircle) map.removeLayer(analysisCircle);
      var center = analysisState.reference.geometry.coordinates;
      analysisCircle = L.circle([center[1], center[0]], { radius: r * 1000, color: '#10b981' }).addTo(map);

      var within = analysisState.blackspotFC.features.filter(f => {
        return turf.distance(analysisState.reference, f, { units: 'kilometers' }) <= r;
      });

      setAnalysisMessage(`Ditemukan <strong>${within.length}</strong> titik dalam radius ${r} KM.`);
    }

    function clearAnalysis() {
      if (analysisMarker) map.removeLayer(analysisMarker);
      if (destinationMarker) map.removeLayer(destinationMarker);
      if (analysisLine) map.removeLayer(analysisLine);
      if (analysisCircle) map.removeLayer(analysisCircle);
      if (nearestLine) map.removeLayer(nearestLine);

      analysisState.reference = null;
      analysisState.destination = null;
      activateButtons();
      setAnalysisMessage('Analisis di-reset.');
    }

    // --- Interaction Hooks ---

    map.on('click', function (e) {
      if (analysisState.mode === 'reference') {
        setReferencePoint(e.latlng);
        analysisState.mode = null;
        document.getElementById('map').style.cursor = '';
        return;
      }
      if (analysisState.mode === 'destination') {
        setDestinationPoint(e.latlng);
        analysisState.mode = null;
        document.getElementById('map').style.cursor = '';
        return;
      }
      if (analysisState.mode === 'report') {
        handleAddReportClick(e.latlng);
        analysisState.mode = null;
        document.getElementById('map').style.cursor = '';
        return;
      }
      // Normal click... close details maybe?
      // closeDetail();
    });

    document.getElementById('setReferenceBtn').onclick = () => {
      analysisState.mode = 'reference';
      document.getElementById('map').style.cursor = 'crosshair';
      setAnalysisMessage('Klik lokasi di peta untuk titik acuan.');
    };

    document.getElementById('setDestinationBtn').onclick = () => {
      analysisState.mode = 'destination';
      document.getElementById('map').style.cursor = 'crosshair';
      setAnalysisMessage('Klik lokasi di peta untuk titik tujuan.');
    };

    document.getElementById('nearestBtn').onclick = runNearest;
    document.getElementById('distanceBtn').onclick = drawDistanceLine; // re-run
    document.getElementById('radiusBtn').onclick = runRadius;
    document.getElementById('clearAnalysisBtn').onclick = clearAnalysis;

    // --- Reporting System ---

    document.getElementById('addReportBtnMain').onclick = () => {
      analysisState.mode = 'report';
      document.getElementById('map').style.cursor = 'crosshair';
      alert("Klik lokasi di peta untuk menambahkan laporan baru.");
    };

    function handleAddReportClick(latlng) {
      var nama = prompt('Nama lokasi/kejadian:', 'Laporan Baru');
      if (!nama) return;
      var jenis = prompt('Jenis kejadian:', 'Kecelakaan');
      var korban = prompt('Korban:', '0 Luka');
      var waktu = new Date().toLocaleString();

      var feature = {
        type: 'Feature',
        properties: {
          nama: nama, kecelakaan: jenis, korban: korban, waktu: waktu,
          _id: 'rep_' + Date.now(), _user: true
        },
        geometry: { type: 'Point', coordinates: [latlng.lng, latlng.lat] }
      };

      addFeatureToMap(feature);
      saveUserReport(feature);
      updateDetailDrawer(feature);
      updateStats();
    }

    function addFeatureToMap(feature) {
      // Register feature
      analysisState.features.push(feature);
      analysisState.blackspotFC = turf.featureCollection(analysisState.features);

      var latlng = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
      var icon = feature.properties._user ? redIcon : redIcon; // Can customize icon

      var marker = L.marker(latlng, { icon: icon }).addTo(feature.properties._user ? userReportLayer : markerLayer);
      marker.bindTooltip(feature.properties.nama);
      marker.on('click', () => {
        updateDetailDrawer(feature);
        map.setView(latlng, 15);
      });
    }

    function saveUserReport(feature) {
      var reports = JSON.parse(localStorage.getItem('userReports') || '{"type":"FeatureCollection","features":[]}');
      reports.features.push(feature);
      localStorage.setItem('userReports', JSON.stringify(reports));
    }

    function deleteUserReport(id) {
      if (!confirm("Hapus laporan ini?")) return;

      var reports = JSON.parse(localStorage.getItem('userReports') || '{"type":"FeatureCollection","features":[]}');
      reports.features = reports.features.filter(f => f.properties._id !== id);
      localStorage.setItem('userReports', JSON.stringify(reports));

      location.reload(); // Simple reload to refresh state cleanly
    }

    // --- Data Loading ---

    // 1. Load LocalStorage Reports
    try {
      var userReports = JSON.parse(localStorage.getItem('userReports') || '{"type":"FeatureCollection","features":[]}');
      userReports.features.forEach(addFeatureToMap);
    } catch (e) { console.error(e); }

    // 2. Load Blackspot Data
    fetch('data/blackspot.geojson')
      .then(res => res.json())
      .then(data => {
        if (data.features) {
          data.features.forEach(addFeatureToMap);
          updateStats();

          // Load Heatmap
          var heatPoints = data.features.map(f => [f.geometry.coordinates[1], f.geometry.coordinates[0], 0.5]);
          heatmapLayer = L.heatLayer(heatPoints, { radius: 30, blur: 20 }).addTo(map);

          // Zoom to first point
          if (data.features.length > 0) {
            var first = data.features[0].geometry.coordinates;
            map.setView([first[1], first[0]], 11);
          }
        }
      })
      .catch(err => console.error("Failed handling geojson", err));

    // 3. TomTom Traffic
    function loadTraffic() {
      var apiKey = '4CZMpEqq9NEItsBXz1h0bshCz1RArdEs';
      var url = 'https://api.tomtom.com/traffic/services/5/incidentDetails?bbox=106.27,-7.38,107.07,-6.57&fields={incidents{type,geometry{type,coordinates},properties{iconCategory}}}&language=en-GB&categoryFilter=1&timeValidityFilter=present&key=' + apiKey;

      document.getElementById('trafficStatus').innerText = "Updating traffic...";

      fetch(url).then(r => r.json()).then(data => {
        trafficIncidentLayer.clearLayers();
        var incidents = data.incidents || [];
        document.getElementById('stats-tomtom').innerText = incidents.length;
        document.getElementById('trafficStatus').innerText = "Live Traffic: " + incidents.length + " incident(s)";

        incidents.forEach(inc => {
          if (inc.geometry.type === 'Point') {
            // Simple marker for traffic
            L.circleMarker([inc.geometry.coordinates[1], inc.geometry.coordinates[0]], {
              radius: 6, color: '#f59e0b', fillOpacity: 0.8
            }).bindPopup("Traffic Incident: " + inc.properties.iconCategory).addTo(trafficIncidentLayer);
          }
        });
      }).catch(e => {
        document.getElementById('trafficStatus').innerText = "Traffic Offline";
      });
    }

    loadTraffic();
    document.getElementById('refreshTrafficBtn').onclick = loadTraffic;

    // --- Layers Control ---
    var baseMaps = { "OpenStreetMap": osm, "Satellite": satellite };
    var overlays = {
      "Blackspots": markerLayer,
      "User Reports": userReportLayer,
      "TomTom Traffic": trafficIncidentLayer
      // Heatmap handled manually as it might be null initially
    };
    L.control.layers(baseMaps, overlays).addTo(map);

  </script>
</body>

</html>