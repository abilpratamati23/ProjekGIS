<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Analisis Titik Rawan Kecelakaan (Blackspot) Kabupaten Sukabumi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="assets/styles.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 70vh; }
    .popup-content { font-family: Arial, sans-serif; line-height: 1.4; }
    .popup-content h4 { margin: 0 0 5px; color: #b30000; }
    .popup-content p { margin: 2px 0; }
    .leaflet-tooltip {
      background: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 13px;
      padding: 3px 6px;
      border-radius: 4px;
    }
    body { font-family: Arial, sans-serif; color: #1f2937; }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }
    .intro-title { margin: 0 0 8px; font-size: 28px; color: #111827; }
    .intro-subtitle { margin: 0 0 16px; font-size: 16px; color: #4b5563; }
    .intro { margin-bottom: 16px; }
    /* Minimal inline fallback to ensure sidebar shows even if external CSS fails */
    .split { display: grid; grid-template-columns: 380px 1fr; gap: 16px; align-items: stretch; padding: 0 16px 24px; }
    .sidebar { background: #ffffff; border-radius: 12px; box-shadow: 0 6px 18px rgba(2,6,23,0.15); }
  </style>
</head>
<body>
  <div class="container intro">
    <h1 class="intro-title">Analisis Titik Rawan Kecelakaan (Blackspot)</h1>
    <p class="intro-subtitle">Kabupaten Sukabumi</p>
    <p>
      Halaman ini menampilkan peta interaktif lokasi-lokasi rawan kecelakaan
      beserta informasi singkatnya. Silakan gulir ke bawah untuk melihat peta,
      pilih layer yang diinginkan, dan klik marker untuk detail lokasi.
    </p>
  </div>

  <div class="split">
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-hero">
        <div class="hero-top">
          <div class="hero-icon">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z"/></svg>
          </div>
          <div>
            <p class="hero-title">Blackspot Details</p>
            <p class="hero-subtitle">Klik marker pada peta untuk melihat ringkasan lokasi.</p>
          </div>
        </div>
        <div class="hero-divider"></div>
      </div>
      <div id="sidebar-content" class="sidebar-content">
        <div class="placeholder">
          <div class="dot"></div>
          <p>Pilih marker pada peta untuk menampilkan ringkasan kecelakaan.</p>
        </div>
      </div>
      <div class="sidebar-footer">
        <button id="reportBtn" class="primary-btn" disabled>Laporkan Lokasi</button>
        <button id="deleteBtn" class="danger-btn" disabled>Hapus Laporan</button>
      </div>
    </aside>
    <div id="map"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ===============================
    // INISIALISASI MAP & BASE LAYER
    // ===============================
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    });

    var satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      maxZoom: 20,
      subdomains:['mt0','mt1','mt2','mt3'],
      attribution: '© Google Satellite'
    });

    var map = L.map('map', {
      center: [-6.9241, 106.9284],
      zoom: 11,
      layers: [osm] // default layer
    });

    var redIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/484/484167.png',
      iconSize: [30, 30],
      iconAnchor: [15, 30],
      popupAnchor: [0, -25]
    });

    var markerLayer = L.layerGroup();
    var userReportLayer = L.layerGroup();
    var userReportIndex = {}; // _id -> marker

    // ===============================
    // UTIL: RENDER & STORAGE LAPORAN PENGGUNA
    // ===============================
    function featureToMarker(feature) {
      var coords = feature.geometry && feature.geometry.coordinates;
      if (!coords || coords.length < 2) return null;
      var latlng = L.latLng(coords[1], coords[0]);
      var marker = L.marker(latlng, { icon: redIcon });
      var name = (feature.properties && feature.properties.nama) || 'Laporan Pengguna';
      marker.bindTooltip(name);
      marker.on('click', function() {
        updateSidebar(feature);
        map.setView(latlng, 14);
      });
      return marker;
    }

    function addUserReportFeature(feature) {
      if (!feature.properties) feature.properties = {};
      if (!feature.properties._id) {
        feature.properties._id = 'rep_' + Date.now().toString(36) + Math.random().toString(36).slice(2,8);
      }
      feature.properties._user = true;
      var marker = featureToMarker(feature);
      if (marker) {
        marker.addTo(userReportLayer);
        userReportIndex[feature.properties._id] = marker;
      }
    }

    function loadUserReports() {
      try {
        var raw = localStorage.getItem('userReports');
        if (!raw) return;
        var geojson = JSON.parse(raw);
        if (!geojson || !Array.isArray(geojson.features)) return;
        geojson.features.forEach(addUserReportFeature);
      } catch (e) {
        console.warn('Gagal memuat laporan pengguna dari localStorage', e);
      }
    }

    function saveUserReport(feature) {
      var collection = { type: 'FeatureCollection', features: [] };
      try {
        var raw = localStorage.getItem('userReports');
        if (raw) {
          var parsed = JSON.parse(raw);
          if (parsed && Array.isArray(parsed.features)) collection.features = parsed.features;
        }
      } catch (e) {
        // mulai koleksi baru jika parsing gagal
      }
      if (!feature.properties) feature.properties = {};
      if (!feature.properties._id) {
        feature.properties._id = 'rep_' + Date.now().toString(36) + Math.random().toString(36).slice(2,8);
      }
      feature.properties._user = true;
      collection.features.push(feature);
      localStorage.setItem('userReports', JSON.stringify(collection));
    }

    function updateSidebar(feature) {
      var props = feature.properties || {};
      var container = document.getElementById('sidebar-content');
      container.innerHTML = `
        <div class="info-card">
          <h3 class="info-title">${props.nama || 'Lokasi Tanpa Nama'}</h3>
          <div class="summary">
            <div class="summary-item"><div class="summary-label">Jenis</div><div class="summary-value">${(props.kecelakaan || '-').split(' ')[0]}</div></div>
            <div class="summary-item"><div class="summary-label">Korban</div><div class="summary-value">${props.korban ? props.korban.split(',')[0] : '-'}</div></div>
            <div class="summary-item"><div class="summary-label">Waktu</div><div class="summary-value">${props.waktu ? props.waktu.split(',')[0] : '-'}</div></div>
          </div>
          <div class="kv">
            <div class="kv-row"><span class="kv-label">Jenis Kejadian</span><span class="kv-value">${props.kecelakaan || '-'}</span></div>
            <div class="kv-row"><span class="kv-label">Korban</span><span class="kv-value">${props.korban || '-'}</span></div>
            <div class="kv-row"><span class="kv-label">Waktu</span><span class="kv-value">${props.waktu || '-'}</span></div>
            <div class="kv-row"><span class="kv-label">Koordinat</span><span class="kv-value">${(feature.geometry && feature.geometry.coordinates) ? feature.geometry.coordinates[1].toFixed(5) + ', ' + feature.geometry.coordinates[0].toFixed(5) : '-'}</span></div>
          </div>
          <div class="divider"></div>
          <p class="muted">Ringkasan lokasi blackspot. Pilih titik lain di peta untuk melihat detail berbeda.</p>
        </div>
      `;
      var reportBtn = document.getElementById('reportBtn');
      var deleteBtn = document.getElementById('deleteBtn');
      reportBtn.disabled = false;
      reportBtn.innerHTML = '\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14M5 12h14" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>\n        Tambah Laporan\n      ';
      // Atur tombol Hapus: hanya aktif untuk laporan pengguna
      if (props._user && props._id) {
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = '\n        Hapus Laporan\n      ';
        deleteBtn.onclick = function() {
          if (!confirm('Hapus laporan ini?')) return;
          try {
            var raw = localStorage.getItem('userReports');
            var collection = raw ? JSON.parse(raw) : { type: 'FeatureCollection', features: [] };
            collection.features = (collection.features || []).filter(function(f) {
              return !(f && f.properties && f.properties._id === props._id);
            });
            localStorage.setItem('userReports', JSON.stringify(collection));

            // Hapus marker dari peta jika ada
            var marker = userReportIndex[props._id];
            if (marker) {
              userReportLayer.removeLayer(marker);
              delete userReportIndex[props._id];
            }

            // Reset sidebar ke placeholder
            document.getElementById('sidebar-content').innerHTML = '\n        <div class="placeholder">\n          <div class="dot"></div>\n          <p>Pilih marker pada peta untuk menampilkan ringkasan kecelakaan.</p>\n        </div>\n      ';
            deleteBtn.disabled = true;
          } catch (e) {
            alert('Gagal menghapus laporan.');
          }
        };
      } else {
        deleteBtn.disabled = true;
        deleteBtn.onclick = null;
      }

      reportBtn.onclick = function() {
        var originalLabel = reportBtn.innerHTML;
        reportBtn.disabled = true;
        reportBtn.innerHTML = '\n        Pilih lokasi di peta...\n      ';

        var clickOnce = function(e) {
          map.off('click', clickOnce);
          var latlng = e.latlng;
          var nama = prompt('Nama lokasi/kejadian:', props.nama || 'Laporan Pengguna');
          if (nama === null) { reportBtn.disabled = false; reportBtn.innerHTML = originalLabel; return; }
          var jenis = prompt('Jenis kejadian (mis. Tabrakan beruntun):', props.kecelakaan || 'Kecelakaan');
          if (jenis === null) { reportBtn.disabled = false; reportBtn.innerHTML = originalLabel; return; }
          var korban = prompt('Korban (mis. 1 meninggal, 2 luka):', props.korban || '0 meninggal, 0 luka');
          if (korban === null) { reportBtn.disabled = false; reportBtn.innerHTML = originalLabel; return; }
          var waktu = prompt('Waktu (mis. 12 Nov 2025, 14:30):', props.waktu || new Date().toLocaleString());
          if (waktu === null) { reportBtn.disabled = false; reportBtn.innerHTML = originalLabel; return; }

          var feature = {
            type: 'Feature',
            properties: { nama: nama, kecelakaan: jenis, korban: korban, waktu: waktu },
            geometry: { type: 'Point', coordinates: [latlng.lng, latlng.lat] }
          };

          addUserReportFeature(feature);
          saveUserReport(feature);
          updateSidebar(feature);

          reportBtn.disabled = false;
          reportBtn.innerHTML = originalLabel;
        };

        map.on('click', clickOnce);
      };
    }

    // ===============================
    // POLYLINE (JALUR JALAN UTAMA)
    // ===============================
    var polylineLayer = L.polyline([
      [-6.9218, 106.9425],
      [-6.933, 106.975],
      [-6.941, 106.898],
      [-6.879, 106.842],
      [-6.823, 106.783]
    ], {
      color: 'blue',
      weight: 4,
      opacity: 0.7
    }).bindPopup("Jalur utama penghubung antar kecamatan");

    // ===============================
    // POLYGON (BATAS KECAMATAN DUMMY)
    // ===============================
    var polygonLayer = L.polygon([
      [-6.89, 106.90],
      [-6.92, 106.97],
      [-6.96, 106.95],
      [-6.94, 106.88]
    ], {
      color: 'green',
      fillColor: '#00FF00',
      fillOpacity: 0.2
    }).bindPopup("Batas wilayah Kecamatan Sukaraja (contoh)");

    // ===============================
    // KONTROL LAYER
    // ===============================
    var baseMaps = {
      "OpenStreetMap": osm,
      "Satellite": satellite
    };

    var overlayMaps = {
      "Titik Blackspot": markerLayer,
      "Laporan Pengguna": userReportLayer,
      "Jalur Utama": polylineLayer,
      "Batas Kecamatan": polygonLayer
    };

    L.control.layers(baseMaps, overlayMaps).addTo(map);

    // Default tampil semua overlay
    markerLayer.addTo(map);
    polylineLayer.addTo(map);
    polygonLayer.addTo(map);
    userReportLayer.addTo(map);

    // ===============================
    // MUAT DATA GEOJSON DARI FILE
    // ===============================
    fetch('data/blackspot.geojson')
      .then(function(res) { return res.json(); })
      .then(function(blackspotData) {
        var geoLayer = L.geoJSON(blackspotData, {
          pointToLayer: function(feature, latlng) {
            return L.marker(latlng, { icon: redIcon });
          },
          onEachFeature: function(feature, layer) {
            layer.bindTooltip(feature.properties.nama);
            layer.on('click', function() {
              updateSidebar(feature);
              map.setView(layer.getLatLng(), 14);
            });
          }
        });
        geoLayer.addTo(markerLayer);

        // Pilih satu data pertama untuk ditampilkan di sidebar saat awal
        if (blackspotData.features && blackspotData.features.length > 0) {
          updateSidebar(blackspotData.features[0]);
        }

        // Muat laporan pengguna dari localStorage
        loadUserReports();
      })
      .catch(function(err) {
        console.error('Gagal memuat data GeoJSON:', err);
      });
  </script>
</body>
</html>